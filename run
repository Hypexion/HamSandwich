#!/bin/bash
# ./run - build then run a project in the appropriate directory
set -euo pipefail

show_help() {
	echo "Usage: $0 <project> [<options>]"
	echo "Available projects:"
	echo "    lunatic  supreme  sleepless  loonyland  loonyland2  mystic"
	echo "Options:"
	echo "    --fullscreen  Run the game in fullscreen (default: windowed)."
	echo "    --release     Run the release build of the game (default: debug)."
	echo "    --gdb         Start GDB prepared to debug the game."
	echo "    --nobuild     Skip compiling before running."
	echo "    --clang       Compile using the clang toolchain (default: gcc)."
	echo "    --valgrind    Run the game under valgrind memory checker (slow)."
	echo "    --callgrind   Run the game under callgrind profiler (slow)."
	echo "    --two         Run two copies of the game at once."
	echo "    --32, --64    Explicitly specify an architecture."
}

# Default settings
TOOL=
PROJECT=
CONFIG=debug
PLATFORM=x86
ARGS=window
NOBUILD=
TOOLSET=gcc
TWO=

# Default bitness
if [ "${MSYSTEM:-}" = "MINGW64" ]; then
	PLATFORM=x86_64
elif [[ "$(uname -v)" = *Ubuntu* ]] && [ "$(uname -m)" = "x86_64" ]; then
	PLATFORM=x86_64
fi

# Read command-line arguments
while [ $# -ne 0 ]; do
	ARG="$1"; shift
	case "$ARG" in
		"--fullscreen")
			ARGS=
			;;
		"--release")
			CONFIG=release
			;;
		"--32")
			PLATFORM=x86
			;;
		"--64")
			PLATFORM=x86_64
			;;
		"--gdb")
			TOOL=gdb
			;;
		"--valgrind")
			TOOL=valgrind
			;;
		"--callgrind")
			TOOL=callgrind
			;;
		"--nobuild")
			NOBUILD=ON
			;;
		"--clang")
			TOOLSET=clang
			;;
		"--web")
			TOOLSET=emcc
			PLATFORM=x86
			;;
		"--two")
			TWO=ON
			;;
		-*)
			show_help; exit 1
			;;
		*)
			if [ "$PROJECT" ]; then
				# Exit if two projects were specified
				show_help; exit 1
			fi
			PROJECT=$ARG
			;;
	esac
done
if [ -z "$PROJECT" ]; then
	# Exit if no project was specified
	show_help; exit 1
fi
MAKE_CONFIG="${CONFIG}_${PLATFORM}"
CONFIG="${CONFIG}-${PLATFORM}"

# Ensure all dependencies are installed
./tools/build/install-deps.sh

# Ensure the project's assets exist
GAMEDIR="build/game/$PROJECT"
if [ "$TOOLSET" = "emcc" ]; then
	# If there's no Emscripten SDK active, then activate a private one.
	if ! command -v em++ >/dev/null 2>&1; then
		source ./tools/build/install-emsdk.sh
	fi

	# Emscripten doesn't require extracting assets ahead of time, because
	# the installers are provided to the game at runtime.
	GAMEDIR="$PWD/build/$TOOLSET/$CONFIG/$PROJECT"
elif [ ! -d "$GAMEDIR" ]; then
	./tools/build/extract-assets.sh "$PROJECT" "$GAMEDIR"
fi

# Ensure the project's build is up to date
if [ -z "$NOBUILD" ]; then
	make "$PROJECT" config="$MAKE_CONFIG" toolset="$TOOLSET"
fi

# Run the project
EXE="$PWD/build/$TOOLSET/$CONFIG/$PROJECT/$PROJECT"
cd "$GAMEDIR"
if [ "$TOOL" = "gdb" ]; then
	echo "==== Debugging $PROJECT ($CONFIG) ===="
	# Catches "the runtime was asked to terminate in an usual way".
	# If libc++ is dynamically linked, the breakpoint should be pending.
	gdb -q \
		-ex 'set breakpoint pending on' \
		-ex 'break abort' \
		-ex 'set breakpoint pending auto' \
		--args "$EXE" $ARGS
elif [ "$TOOL" = "valgrind" ]; then
	echo "==== Valgrinding $PROJECT ($CONFIG) ===="
	valgrind "$EXE" $ARGS
elif [ "$TOOL" = "callgrind" ]; then
	echo "==== Callgrinding $PROJECT ($CONFIG) ===="
	valgrind --tool=callgrind "$EXE" $ARGS
elif [ "$TOOLSET" = "emcc" ]; then
	echo "==== Hosting $PROJECT ($CONFIG) ===="
	emrun --serve_after_close "index.html"
else
	echo "==== Running $PROJECT ($CONFIG) ===="
	if [ "$TWO" ]; then
		"$EXE" $ARGS &
	fi
	"$EXE" $ARGS
	wait
fi
